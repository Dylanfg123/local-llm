services:
  vllm:
    image: vllm/vllm-openai:latest
    command: >
      --model astronomer/Llama-3-8B-Instruct-GPTQ-8-Bit
      --host 0.0.0.0
      --port 8000
      --dtype auto
      --api-key devkey123
      --max-model-len 4096
      --enforce-eager
    environment:
      - HF_TOKEN=${HF_TOKEN:-}
      - NVIDIA_VISIBLE_DEVICES=all
      - NVIDIA_DRIVER_CAPABILITIES=compute,utility
    volumes:
      - "C:\\AI_Models:/root/.cache/huggingface"
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              capabilities: [gpu]
    networks: [ llmnet ]

  rag-api:
    image: python:3.11-slim
    working_dir: /app
    command: sh -c "pip install --no-cache-dir fastapi uvicorn[standard] httpx python-multipart pypdf ddgs && uvicorn app:app --host 0.0.0.0 --port 7000"
    volumes:
      - ./rag/app.py:/app/app.py:ro
    environment:
      # TALK TO VLLM THROUGH THE UI PROXY OR DIRECTLY WITH /v1 (both OK)
      - VLLM_URL=http://vllm:8000
      - QDRANT_URL=http://qdrant:6333
      - TEI_URL=http://embedder
      - OPENAI_API_KEY=devkey123
    depends_on: [ vllm, qdrant, embedder]
    ports: ["7000:7000"]
    networks: [ llmnet ]

  ui:
    image: node:20-alpine
    working_dir: /app                   # ✅ critical (your old one wasn’t fixed)
    command: sh -c "npm i && node server.js"
    volumes:
      - ./ui:/app                       # ui/ contains server.js, package.json, public/index.html
    environment:
      - VLLM_URL=http://vllm:8000       # proxy target
      - RAG_URL=http://rag-api:7000
    ports: ["5173:5173"]
    depends_on: [ vllm, rag-api ]
    networks: [ llmnet ]

  qdrant:
    image: qdrant/qdrant:latest # override via .env when older data files require a legacy build
    volumes:
      - ./qdrant_data:/qdrant/storage
    ports: ["6333:6333"]
    networks: [ llmnet ]

  embedder:
    image: python:3.11-slim
    working_dir: /app
    command: >
      sh -c "pip install --no-cache-dir fastapi uvicorn[standard] pydantic sentence-transformers &&
      uvicorn embed_service:app --host 0.0.0.0 --port 80"
    volumes:
      - ./rag/embed_service.py:/app/embed_service.py:ro
      - "C:\\AI_Models:/root/.cache/huggingface"
    environment:
      - MODEL_ID=sentence-transformers/all-MiniLM-L6-v2
      - HF_TOKEN=${HF_TOKEN:-}
      - HUGGINGFACEHUB_API_TOKEN=${HF_TOKEN:-}
      - HF_HOME=/root/.cache/huggingface
      - TRANSFORMERS_CACHE=/root/.cache/huggingface
    ports: ["8080:80"]
    networks: [ llmnet ]


networks:
  llmnet:
    driver: bridge
